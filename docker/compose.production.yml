# Kura Training — Production Compose
#
# Joins the moltbot-internal network so Fred (gateway) can reach kura-api.
# No ports exposed to the host — access only via Docker network.
#
# Usage:
#   docker compose -f docker/compose.production.yml up -d
#
# Requires: .env.production in docker/ with KURA_DB_PASSWORD

services:
  kura-postgres:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: kura
      POSTGRES_USER: kura
      POSTGRES_PASSWORD: ${KURA_DB_PASSWORD}
    volumes:
      - kura-pgdata:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kura -d kura"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  kura-api:
    build:
      context: ..
      dockerfile: Dockerfile
      target: api
    environment:
      DATABASE_URL: postgresql://kura:${KURA_DB_PASSWORD}@kura-postgres:5432/kura
      PORT: "3000"
      RUST_LOG: "kura_api=info,tower_http=info"
    depends_on:
      kura-postgres:
        condition: service_healthy
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  kura-proxy:
    build:
      context: ./kura-proxy
    environment:
      KURA_API_KEY: ${KURA_API_KEY}
    depends_on:
      kura-api:
        condition: service_healthy
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8320/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  kura-worker:
    build:
      context: ../workers
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://kura:${KURA_DB_PASSWORD}@kura-postgres:5432/kura
      KURA_POLL_INTERVAL: "5.0"
      KURA_BATCH_SIZE: "10"
      KURA_LOG_FORMAT: "json"
      KURA_HEALTH_PORT: "8081"
    depends_on:
      kura-postgres:
        condition: service_healthy
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8081/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  kura-pgdata:

networks:
  moltbot-internal:
    # Docker Compose prefixes network names with the project name.
    # moltbot's compose creates "moltbot_moltbot-internal".
    name: moltbot_moltbot-internal
    external: true
