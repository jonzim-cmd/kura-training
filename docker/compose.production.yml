# Kura Training â€” Production Compose
#
# Joins the moltbot-internal network so Fred (gateway) can reach kura-api.
# Localhost-only ports are exposed for Cloudflare Tunnel ingress.
#
# Usage:
#   docker compose -f docker/compose.production.yml up -d
#
# Requires: .env.production in docker/ with KURA_DB_PASSWORD, KURA_API_KEY,
# KURA_AGENT_MODEL_ATTESTATION_SECRET, and public routing values.
# Required DB URLs:
#   KURA_API_DATABASE_URL
#   KURA_WORKER_DATABASE_URL
# Required web/public routing values:
#   KURA_WEB_PUBLIC_API_URL
#   KURA_WEB_PUBLIC_MCP_URL
#   KURA_FRONTEND_URL
#   KURA_CORS_ORIGINS
# Required Supabase auth values:
#   SUPABASE_URL
#   SUPABASE_ANON_KEY
# Required Turnstile values:
#   KURA_TURNSTILE_SITE_KEY
#   KURA_TURNSTILE_SECRET_KEY
# Optional override:
#   KURA_WORKER_LISTEN_DATABASE_URL

services:
  kura-postgres:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: kura
      POSTGRES_USER: kura
      POSTGRES_PASSWORD: ${KURA_DB_PASSWORD}
    volumes:
      - kura-pgdata:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kura -d kura"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  kura-api:
    build:
      context: ..
      dockerfile: Dockerfile
      target: api
    environment:
      DATABASE_URL: ${KURA_API_DATABASE_URL:?KURA_API_DATABASE_URL must be set}
      PORT: "3000"
      RUST_LOG: "kura_api=info,tower_http=info"
      KURA_AGENT_MODEL_ATTESTATION_SECRET: ${KURA_AGENT_MODEL_ATTESTATION_SECRET}
      SIGNUP_GATE: ${SIGNUP_GATE:-invite}
      FRONTEND_URL: ${KURA_FRONTEND_URL:?KURA_FRONTEND_URL must be set}
      KURA_CORS_ORIGINS: ${KURA_CORS_ORIGINS:?KURA_CORS_ORIGINS must be set}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-Kura <noreply@withkura.com>}
      ADMIN_NOTIFY_EMAIL: ${ADMIN_NOTIFY_EMAIL:-}
      KURA_WEB_PUBLIC_API_URL: ${KURA_WEB_PUBLIC_API_URL:-https://api.withkura.com}
      SUPABASE_URL: ${SUPABASE_URL:?SUPABASE_URL must be set}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:?SUPABASE_ANON_KEY must be set}
      TURNSTILE_SECRET_KEY: ${KURA_TURNSTILE_SECRET_KEY:?KURA_TURNSTILE_SECRET_KEY must be set}
      TURNSTILE_EXPECTED_HOSTNAME: ${KURA_TURNSTILE_EXPECTED_HOSTNAME:-}
      KURA_MCP_DETERMINISM_ROLLOUT_MODE: ${KURA_MCP_DETERMINISM_ROLLOUT_MODE:-full}
      KURA_MCP_DETERMINISM_CANARY_PERCENT: ${KURA_MCP_DETERMINISM_CANARY_PERCENT:-10}
      KURA_MCP_DETERMINISM_CANARY_ALLOWLIST: ${KURA_MCP_DETERMINISM_CANARY_ALLOWLIST:-}
      KURA_MCP_DETERMINISM_CANARY_USER_ALLOWLIST: ${KURA_MCP_DETERMINISM_CANARY_USER_ALLOWLIST:-}
      KURA_MCP_DETERMINISM_CANARY_EMAIL_ALLOWLIST: ${KURA_MCP_DETERMINISM_CANARY_EMAIL_ALLOWLIST:-}
      KURA_MCP_DETERMINISM_ABORT_ON_BREACH: ${KURA_MCP_DETERMINISM_ABORT_ON_BREACH:-false}
      KURA_MCP_ROLLOUT_ABORT_OVERFLOW_RATE_MAX: ${KURA_MCP_ROLLOUT_ABORT_OVERFLOW_RATE_MAX:-0.45}
      KURA_MCP_ROLLOUT_ABORT_CRITICAL_MISSING_RATE_MAX: ${KURA_MCP_ROLLOUT_ABORT_CRITICAL_MISSING_RATE_MAX:-0.15}
      KURA_MCP_ROLLOUT_ABORT_BLOCKED_RATE_MAX: ${KURA_MCP_ROLLOUT_ABORT_BLOCKED_RATE_MAX:-0.35}
      KURA_MCP_ROLLOUT_ABORT_SPECULATIVE_RATE_MAX: ${KURA_MCP_ROLLOUT_ABORT_SPECULATIVE_RATE_MAX:-0.02}
      KURA_MCP_ROLLOUT_MIN_CONTEXT_CALLS: ${KURA_MCP_ROLLOUT_MIN_CONTEXT_CALLS:-3}
      KURA_MCP_ROLLOUT_MIN_TOTAL_CALLS: ${KURA_MCP_ROLLOUT_MIN_TOTAL_CALLS:-10}
    depends_on:
      kura-postgres:
        condition: service_healthy
    networks:
      - moltbot-internal
    ports:
      - "127.0.0.1:${KURA_API_PUBLIC_PORT:-8330}:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  kura-proxy:
    build:
      context: ./kura-proxy
    environment:
      KURA_API_KEY: ${KURA_API_KEY}
    depends_on:
      kura-api:
        condition: service_healthy
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8320/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  kura-worker:
    build:
      context: ../workers
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: ${KURA_WORKER_DATABASE_URL:?KURA_WORKER_DATABASE_URL must be set}
      KURA_WORKER_LISTEN_DATABASE_URL: ${KURA_WORKER_LISTEN_DATABASE_URL:-}
      KURA_POLL_INTERVAL: "1.0"
      KURA_BATCH_SIZE: "10"
      KURA_LOG_FORMAT: "json"
      KURA_HEALTH_PORT: "8081"
    depends_on:
      kura-postgres:
        condition: service_healthy
    networks:
      - moltbot-internal
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8081/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  kura-web:
    build:
      context: ../web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${KURA_WEB_PUBLIC_API_URL:?KURA_WEB_PUBLIC_API_URL must be set}
        NEXT_PUBLIC_KURA_MCP_URL: ${KURA_WEB_PUBLIC_MCP_URL:-https://api.withkura.com/mcp}
        NEXT_PUBLIC_SOCIAL_AUTH_BASE_URL: ${SUPABASE_URL:?SUPABASE_URL must be set}
        NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${KURA_TURNSTILE_SITE_KEY:?KURA_TURNSTILE_SITE_KEY must be set}
    environment:
      NODE_ENV: "production"
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
      NEXT_PUBLIC_API_URL: ${KURA_WEB_PUBLIC_API_URL:?KURA_WEB_PUBLIC_API_URL must be set}
      NEXT_PUBLIC_KURA_MCP_URL: ${KURA_WEB_PUBLIC_MCP_URL:-https://api.withkura.com/mcp}
      NEXT_PUBLIC_SOCIAL_AUTH_BASE_URL: ${SUPABASE_URL:?SUPABASE_URL must be set}
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${KURA_TURNSTILE_SITE_KEY:?KURA_TURNSTILE_SITE_KEY must be set}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      ADMIN_NOTIFY_EMAIL: ${ADMIN_NOTIFY_EMAIL:-}
      EMAIL_FROM: ${EMAIL_FROM:-Kura <noreply@withkura.com>}
    depends_on:
      kura-api:
        condition: service_healthy
    networks:
      - moltbot-internal
    ports:
      - "127.0.0.1:${KURA_WEB_PORT:-3001}:3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://localhost:3000').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  kura-pgdata:

networks:
  moltbot-internal:
    # Docker Compose prefixes network names with the project name.
    # moltbot's compose creates "moltbot_moltbot-internal".
    name: moltbot_moltbot-internal
    external: true
